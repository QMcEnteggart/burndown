<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Burn Down Charts</title>

    <link href="http://google-code-prettify.googlecode.com/svn/trunk/src/prettify.css" type="text/css" rel="stylesheet" />
    <link href="bootstrap/css/bootstrap.min.css" type="text/css" rel="stylesheet" />
    <link href="bootstrap/css/bootstrap-responsive.min.css" type="text/css" rel="stylesheet" />
    <link href="bootstrap/css/style.css" type="text/css" rel="stylesheet" />

    <link href="css/style.css" type="text/css" rel="stylesheet" />
    <style type="text/css">
    html {
        height: 100%;
    }
    body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: calibri;
    }
    #container {
        padding: 50px 10px 40px;
        border: solid 1px #666;
        border-radius: 5px;
        background-color: #FFF;
    }
    </style>
</head>
<body style="background-color: #EEE;" onload="prettyPrint()">
    <div class="navbar navbar-fixed-top">
        <div class="navbar-inner">
            <div class="container">
                <ul class="nav">
                    <li class="dropdown">
                        <a href="#" class="dropdown" data-toggle="dropdown">
                            Projects
                            <b class="caret"></b>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a href="#">Burn Down</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div id="container" class="container">
        <div class="chart">
        </div>
    </div>
    <script src="http://google-code-prettify.googlecode.com/svn/trunk/src/prettify.js" type="text/javascript" rel="javascript"></script>
    <script src="bootstrap/js/jquery-1.7.1.min.js" type="text/javascript" rel="javascript"></script>
    <script src="bootstrap/js/bootstrap.min.js" type="text/javascript" rel="javascript"></script>

    <script type="text/javascript" src="resources/d3.v2.js?2.8.0"></script>
    <script type="text/javascript">
        // Get project json object from api and send it to drawGraph
        $.ajax({
            url: 'http://org.hardconsulting.com/api/data/burndown/effort.json',
            dataType: 'jsonp',
            success: function(d) {
                drawGraph(d)
            }
        })
        // capitalizes to first letter in string
        String.prototype.capitalize = function() {
            return this.charAt(0).toUpperCase() + this.slice(1);
        }

        function drawGraph(d) {
            //
            //   json object structure:
            //   {
            //       list:        Array,   # data array
            //       project:     String,  # project name
            //       style:       String,  # style is the type of graph
            //   }
            //
            var a                = d.list
            var data             = a
            //
            //   Temporarily renames variables to fit old code
            //   -need to translate code to new names
            //
            var q                = []
            for(var u=0;u<data.length;u++) {
                var b            = data[u].estimated
                q[u] = {
                    segment: u+1,
                    remaining: (b['todoTotal#'] - b['added#']),
                    completed: b['done#'],
                    removed: b['removed#'],
                    totalRemoved: b['removedTotal#'],
                    added: b['added#'],
                    totalAdded: b['addedTotal#']
                }
            }

            // Replace data with temporary q data
            var data             = q
            var total            = d3.sum(a, function (d) { return d.estimated['total#'] })

            // Width and Height for the svg element
            var w                = 1170                //document.body.offsetWidth
            var h                = 400                 //document.body.offsetHeight

            // Graph positioning variables
            var margin           = 20 // right side offset
            var left             = 40 // left side offset
            var bottom           = 40 // bottom offset

            // Graph width and height relative to the svg
            // width and height and calculating offsets
            var gWidth           = w - left - margin
            var gHeight          = h - bottom - margin

            // x domain
            var xMin             = 0
            var xMax             = a.length
            // y domain
            var yMin = d3.min(a, function (d) {
                return -( d.estimated['deltaTotal#'] )
            })
            var yMax = d3.max(a, function (d) {
                var e            = d.estimated
                return (e['todoTotal#'] + e['doneTotal#'] - e['addedTotal#'])
            })
            // if yMin is too small to create a rule then force a rule
            var yMin             = yMin > -(yMax/8) ? -(yMax/10) : yMin

            var x = d3.scale.linear()
                .domain([0, xMax])
                .range([0, w - left - margin])
            var y = d3.scale.linear()
                .domain([yMin, yMax])
                .range([0, h - bottom -margin])

            var svg = d3.select('.chart').append('svg')
                .attr('width', w)
                .attr('height', h)
                .attr('style', 'display: block; margin: 0 auto;')
            var xAxis = svg.append('g')
                .attr('class', 'xAxis')
                .attr('transform', 'translate(' + left + ', ' + margin + ')')
            var xRule = xAxis.selectAll('.rule')
                .data(y.ticks(10))
            .enter().append('g')
                .attr("transform", function(d) { return 'translate(0,' + (gHeight - y(d)) + ')'; });
            xRule.append('line')
                .attr('x2', gWidth)
                .attr('style', 'stroke: #EEE; stroke-width: 1; stroke-opacity: 1;')
            xRule.append("text")
                .attr("x", 6)
                .attr("dy", ".25em")
                .attr("transform", "translate(-10,0)")
                .attr('text-anchor', 'end')
                .attr('style', 'font-size: 10pt; fill: #BBB;')
                .text(function(d) { return (Math.round(d/3600)+':00') });

            // Bar configuration
            var barWidth = 20
            var barOffset = 40
            var avg = (barWidth + (barOffset * 2)) / (a.length - 1)
            //console.log('(' + barWidth + ' + ' + '(' + barOffset + ' * 2)) / (' + data.length + ' - 1) ------- ' + (barWidth + (barOffset * 2)) + ' / ' + (data.length - 1) + ' = ' + avg)

            var barX = function (d, i) {
                var total = barWidth + barOffset - (avg*i)
                //console.log(barWidth + ' + ' + barOffset + ' - (' + avg + '*' + i + ') = ' + total )
                return total
            }

            var graph = svg.append('g')
                .attr('width', gWidth)
                .attr('height', gHeight)
                .attr('transform', 'translate(' + (left - barWidth) + ',0)')
            var bars = graph.selectAll('.bars')
                .data(data, function (d) { return d.remaining })
            .enter().append('g')
                .attr('transform', function (d, i) { return 'translate(' + (x(i)) + ', ' + (gHeight + margin) + ')' })

            bars.append('rect')
                .attr('width', barWidth)
                .attr('height', 0)
                .attr('x', barX)
                .attr('y', function (d) { return -(y(d.remaining) + y(d.totalRemoved) - y(0)) })
                .attr('style', 'fill: #DDD; fill-opacity: 0.8;')
                .transition().delay(function (d, i) { return i*20 }).duration(500)
                .attr('height', function (d) { return (y(d.remaining) - y(0)) })
            bars.append('rect')
                .attr('width', barWidth)
                .attr('height', 0)
                .attr('x', barX)
                .attr('y', function (d) { return -(y(d.completed) + y(d.remaining) - y(0) + y(d.totalRemoved) - y(0)) })
                .attr('style', 'fill: #060; fill-opacity: 0.4;')
                .transition().delay(function (d, i) { return i*20 + (xMax*20) }).duration(500)
                .attr('height', function (d) { return (y(d.completed) - y(0)) })
            bars.append('rect')
                .attr('width', barWidth)
                .attr('height', 0)
                .attr('x', barX)
                .attr('y', function (d) { return -y(d.totalRemoved) })
                .attr('style', 'fill: #A00; fill-opacity: 0.5;')
                .transition().delay(function (d, i) { return i*20 + (xMax*20) }).duration(500)
                .attr('height', function (d) { return (y(d.totalAdded) - y(0)) })

            var yAxisX = function (d, i) {
                return (barWidth/2) + barOffset - (avg*i)
            }
            var yAxis = svg.append('g')
                .attr('class', 'xAxis')
                .attr('transform', 'translate(' + left + ', ' + margin + ')')
            var yRule = yAxis.selectAll('.rule')
                .data(data)
            .enter().append('g')
                .attr("transform", function(d, i) { return 'translate(' + x(i) + ', ' + (gHeight) + ')'; });
            yRule.append("text")
                .data(data, function (d) { return d.segment })
                .attr("x", yAxisX)
                .attr("dy", ".0em")
                .attr("transform", function (d, i) {
                    if(i%2==0) {
                        var translate = 'translate(0, 18)'
                    } else {
                        var translate = 'translate(0, 18)'
                    }
                    return translate
                })
                .attr('text-anchor', 'middle')
                .attr('style', 'font-size: 10pt; fill: #BBB;')
                .text(function (p) { return d.style.capitalize() + ' ' + p.segment });

            /*
            var plotX = function (d, i) {
                var total = (barWidth/2) + barOffset - (avg*i)
                total = x(i) + total + barWidth
                return total
            }
            var nextPlotX = function (d, i) {
                var total = (barWidth/2) + barOffset - (avg*i+1)
                total = x(i+1) + total + barWidth
                return total
            }

            graph.append('g').selectAll('line')
                .data(plot)
            .enter().append('line')
                .attr('x1', plotX)
                .attr('x2', plotX)
                .attr('y1', function (d) { return d.y })
                .attr('y2', function (d) { return d.y })
                .style('stroke', '#C00')
                .style('stroke-width', '3')
                .transition().delay(function (d, i) { return (i*50) }).duration(100)
                .attr('x1', plotX)
                .attr('x2', nextPlotX)
                .attr('y1', function (d) { return d.y })
                .attr('y2', function (d, i) {
                    if(plot[i+1]) {
                        return plot[i+1].y
                    } else {
                        return d.y
                    }
                })
            graph.append('g').selectAll('circle')
                .data(plot)
            .enter().append('circle')
                .attr('cx', plotX)
                .attr('cy', function (d) { return d.y })
                .attr('r', 5)
                .style('fill', '#C00')
                .style('fill-opacity', '0')
                .style('stroke', '#500')
                .style('stroke-opacity', '0')
                .transition().delay(function (d, i) { return (i*50) }).duration(100)
                .style('fill-opacity', '1')
                .style('stroke-opacity', '1')
            */
        }

    </script>
</body>
</html>
